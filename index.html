<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Selfie com Vivi 3D</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  canvas { display:block; }
  #captureBtn {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    padding: 10px 16px; border: none; border-radius: 8px;
    background: #0b84ff; color:#fff; font-weight: bold; cursor:pointer;
  }
</style>
</head>
<body>
<button id="captureBtn">ðŸ“¸ Tirar selfie</button>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

  // Cena e cÃ¢mera
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.5, 3);

  // Renderizador
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Controles
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Luzes
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2);
  hemiLight.position.set(0,20,20);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5,10,7.5);
  scene.add(dirLight);

  // Carregar GLB
  const loader = new GLTFLoader();
  loader.load('vivi.glb',
    function(gltf){
      const model = gltf.scene;
      model.scale.set(2,2,2);
      model.position.set(0,-1,0);
      scene.add(model);

      // Centralizar cÃ¢mera
      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x,size.y,size.z);

      camera.position.copy(center);
      camera.position.z += maxDim*2;
      camera.lookAt(center);
      controls.target.copy(center);

      console.log("Modelo carregado!");
    },
    undefined,
    function(error){ console.error("Erro ao carregar modelo:", error); }
  );

  // Responsividade
  window.addEventListener('resize',()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Loop
  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // Webcam selfie
  const video = document.createElement('video');
  video.autoplay=true; video.muted=true; video.playsInline=true; video.style.display='none';
  document.body.appendChild(video);

  navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
    .then(stream=>video.srcObject=stream)
    .catch(err=>console.error('Erro cÃ¢mera:',err));

  document.getElementById('captureBtn').addEventListener('click',()=>{
    const w=window.innerWidth, h=window.innerHeight;
    const canvas=document.createElement('canvas');
    canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext('2d');

    // VÃ­deo espelhado
    ctx.save(); ctx.translate(w,0); ctx.scale(-1,1);
    ctx.drawImage(video,0,0,w,h);
    ctx.restore();

    // Render 3D
    ctx.drawImage(renderer.domElement,0,0,w,h);

    // Salvar
    const link=document.createElement('a');
    link.download='selfie_vivi.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  });
</script>
</body>
</html>
