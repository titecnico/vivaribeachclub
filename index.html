<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Selfie AR - Vivari Beach Club</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  body { margin:0; background:#000; overflow:hidden; font-family:Arial,sans-serif; }
  #cameraVideo {
    position:fixed; top:0; left:0; width:100vw; height:100vh;
    object-fit:cover; z-index:0;
    pointer-events:none;
  }
  #modelContainer {
    position:fixed; top:0; left:0; width:100vw; height:100vh;
    z-index:1;
  }
  model-viewer {
    width:80%; height:80%;
    position:absolute; top:10%; left:10%;
    pointer-events:auto;
    opacity:0.9;
  }
  #captureBtn, #switchBtn {
    position:absolute; bottom:30px; z-index:10;
    padding:20px 32px; border:none; border-radius:18px;
    background:#0b84ff; color:#fff; font-weight:bold; font-size:24px;
    cursor:pointer; box-shadow:0 6px 12px rgba(0,0,0,0.4);
  }
  #captureBtn { left:50%; transform:translateX(-50%); }
  #switchBtn { right:20px; }
  #qrCode {
    position:absolute; top:20px; left:20px; z-index:10;
    background:#fff; padding:8px; border-radius:8px;
  }
  #rotateHint {
    position:absolute; bottom:100px; left:50%; transform:translateX(-50%);
    z-index:10; color:#fff; font-size:16px; font-weight:bold;
    background:rgba(0,0,0,0.4); padding:8px 12px; border-radius:8px;
  }
</style>
</head>
<body>

<video id="cameraVideo" autoplay playsinline muted></video>

<div id="modelContainer">
  <model-viewer id="model" src="vivi.glb"
                alt="Vivi 3D"
                camera-controls
                auto-rotate
                auto-rotate-delay="0"
                rotation-per-second="20deg"
                camera-orbit="0deg 75deg 1.8m"
                environment-image="neutral"
                shadow-intensity="1"
                scale="0.6">
  </model-viewer>
</div>

<div id="rotateHint">⬅️ Arraste para girar a Vivi ➡️</div>
<button id="captureBtn">📸 Tirar Foto</button>
<button id="switchBtn">🔄 Trocar Câmera</button>
<div id="qrCode"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  // QR Code
  new QRCode(document.getElementById("qrCode"), {
    text: window.location.href,
    width: 100, height: 100
  });

  const video = document.getElementById('cameraVideo');
  const captureBtn = document.getElementById('captureBtn');
  const switchBtn = document.getElementById('switchBtn');
  const modelViewer = document.getElementById('model');

  let currentFacing = "user"; // começa em modo selfie

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing } });
      video.srcObject = stream;
    } catch (err) {
      console.error("Erro ao acessar câmera:", err);
      alert("Não foi possível acessar a câmera.");
    }
  }
  startCamera();

  // Alternar câmera
  switchBtn.addEventListener('click', () => {
    currentFacing = currentFacing === "user" ? "environment" : "user";
    startCamera();
  });

  // Captura foto
  captureBtn.addEventListener('click', async () => {
    try {
      const modelSnapshot = await modelViewer.toDataURL();
      const canvas = document.createElement('canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');

      // Fundo da câmera
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Vivi 3D
      const imgModel = new Image();
      imgModel.onload = () => {
        ctx.drawImage(imgModel, canvas.width*0.1, canvas.height*0.1, canvas.width*0.8, canvas.height*0.8);

        // Marca d'água
        ctx.font = `${Math.floor(canvas.height/20)}px Arial`;
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.textAlign = "right";
        ctx.fillText("Vivari Beach Club", canvas.width-20, canvas.height-20);

        // Salvar
        const link = document.createElement('a');
        link.download = 'foto_vivari.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
      imgModel.src = modelSnapshot;

    } catch (err) {
      console.error("Erro ao capturar:", err);
      alert("Não foi possível capturar a foto.");
    }
  });
</script>

</body>
</html>
